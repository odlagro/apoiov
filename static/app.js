let CATALOGO=[],FRETES={};function formatBRL(n){return n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
async function carregar(){const [cat,fr]=await Promise.all([fetch('/api/catalogo').then(r=>r.json()),fetch('/api/fretes').then(r=>r.json())]);CATALOGO=(cat.produtos||[]).map(p=>({...p,img:(p.img||'').trim(),descricao:(p.descricao||'').trim()}));FRETES=fr.fretes||{};renderTabela();aplicarUF()}
function renderTabela(){const tb=document.querySelector('#tbody-prod');tb.innerHTML='';CATALOGO.forEach(p=>{const tr=document.createElement('tr');tr.dataset.id=p.id;tr.dataset.img=p.img||'';tr.dataset.desc=p.descricao||'';tr.innerHTML=`<td><input type="checkbox" class="pick"></td><td class="nome">${p.nome}</td><td class="cartao" data-cartao="${p.cartao.toFixed(2)}">R$ ${p.cartao.toFixed(2)}</td><td class="avista" data-avista="${p.avista.toFixed(2)}">R$ ${p.avista.toFixed(2)}</td><td class="dez">R$ ${p.parcela10x.toFixed(2)}</td>`;tb.appendChild(tr)})}
function aplicarUF(){const uf=(document.querySelector('#uf').value||'').trim().toUpperCase();const inputFrete=document.querySelector('#frete');const hint=document.querySelector('#ufHint');if(uf&&FRETES[uf]!=null){inputFrete.value=Number(FRETES[uf]).toFixed(2);inputFrete.setAttribute('disabled','disabled');hint.textContent=`Frete ${uf} aplicado.`}else{inputFrete.removeAttribute('disabled');hint.textContent=''}}
function calcular(){const frete=Number(document.querySelector('#frete').value||0),desconto=Number(document.querySelector('#desconto').value||0),uf=(document.querySelector('#uf').value||'').trim().toUpperCase();const linhas=Array.from(document.querySelectorAll('#tbody-prod tr'));const selecionadas=linhas.filter(tr=>tr.querySelector('.pick').checked);const resultados=document.querySelector('#resultados');resultados.innerHTML='';if(selecionadas.length===0){resultados.innerHTML='<div style="padding:12px;color:#9aa6bb">Selecione pelo menos um produto.</div>';return}const hdr=document.createElement('div');hdr.style.display='grid';hdr.style.gridTemplateColumns='230px 1fr';hdr.style.gap='16px';hdr.style.padding='8px 14px';hdr.style.background='#1a1f28';hdr.style.border='1px solid #2b323d';hdr.style.borderBottom='0';const h1=document.createElement('div');h1.style.fontWeight='700';h1.textContent='Imagem';const h2=document.createElement('div');h2.style.fontWeight='700';h2.textContent='Mensagem';hdr.appendChild(h1);hdr.appendChild(h2);resultados.appendChild(hdr);selecionadas.forEach(tr=>{const nome=tr.querySelector('.nome').textContent.trim();const precoCartao=Number(tr.querySelector('.cartao').dataset.cartao);const precoAvistaPadrao=Number(tr.querySelector('.avista').dataset.avista);const img=(tr.dataset.img||'').trim();const desc=(tr.dataset.desc||'').trim();const precoCartaoComFrete=precoCartao+frete;const parcela10x=precoCartaoComFrete/10;const precoAvistaComFrete=precoAvistaPadrao+frete;const linhaUF=uf?` PARA ${uf}`:'';const texto=[`*VALOR JÁ INCLUSO O FRETE${linhaUF}*`,`*${nome}*`,`${desc}`,`${formatBRL(precoCartaoComFrete)}`,`até 10x de ${formatBRL(parcela10x)} sem juros`,`ou`,`*PROMOÇÃO:* ${formatBRL(precoAvistaComFrete)} no pix já com ${desconto.toFixed(2)}% de desconto*`].join('\n');const card=document.createElement('div');card.className='card';const photo=document.createElement('div');photo.className='photo';const image=document.createElement('img');image.alt='produto';image.loading='lazy';image.referrerPolicy='no-referrer';image.src=(img&&img.startsWith('http'))?img:'https://via.placeholder.com/600x600?text=Produto';image.onerror=()=>{image.src='https://via.placeholder.com/600x600?text=Produto'};photo.appendChild(image);const right=document.createElement('div');const badge=document.createElement('div');badge.className='badge';badge.textContent='Mensagem pronta';const ta=document.createElement('textarea');ta.value=texto;const actions=document.createElement('div');actions.className='actions';const btnCopy=document.createElement('button');btnCopy.textContent='Copiar texto';btnCopy.onclick=()=>{ta.select();document.execCommand('copy')};const btnDownload=document.createElement('button');btnDownload.textContent='Baixar';btnDownload.onclick=()=>{const blob=new Blob([texto],{type:'text/plain;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=(nome.replace(/\s+/g,'_').toLowerCase())+'_mensagem.txt';a.click();URL.revokeObjectURL(a.href)};actions.appendChild(btnCopy);actions.appendChild(btnDownload);right.appendChild(badge);right.appendChild(ta);right.appendChild(actions);card.appendChild(photo);card.appendChild(right);resultados.appendChild(card)})}
document.getElementById('btn-calcular').addEventListener('click',calcular);document.getElementById('uf').addEventListener('change',aplicarUF);document.getElementById('btn-recarregar').addEventListener('click',carregar);window.addEventListener('DOMContentLoaded',carregar)